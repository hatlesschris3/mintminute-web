<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MintMinute</title>
  <script src="https://cdn.applixir.com/applixir.sdk2.1m.js"></script>
  <script src="user.js"></script>
  <style>
    /* [Your existing styles here] */
  </style>
</head>
<body>
  <div id="appContainer">
    <div id="header">
      <div>MintMinute</div>
      <div id="settingsBtn">&#9776;</div>
    </div>
    <div id="sidebar">
      <div class="closeSidebarBtn" onclick="toggleSidebar()">×</div>
      <h2>Account Settings</h2>
      <div id="prefsSection"></div>
      <div id="authSection"></div>
    </div>
    <div id="adContainer">
      <div id="applixir_parent"></div>
    </div>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }
    document.getElementById('settingsBtn').onclick = toggleSidebar;

    function populateFields() {
      const user = loadUser();
      const prefs = ['survey','quiz','image_tag','video','audio_ad'];
      const prefsHtml = prefs.map(p => `
        <label><input type="checkbox" value="${p}" id="pref_${p}"> ${p.replace('_',' ')}</label>
      `).join('');
      document.getElementById('prefsSection').innerHTML = '<h3>Preferences</h3>' + prefsHtml;
      if (user?.adPref?.length) {
        user.adPref.forEach(p => document.getElementById(`pref_${p}`).checked = true);
      }

      const authHTML = user ? `
        <label>Username:<input id="usernameInput" value="${user.username}"></label>
        <label>Age:<input id="ageInput" type="number" value="${user.age}"></label>
        <label>Balance:</label><div>£${user.balance.toFixed(2)}</div>
        <button onclick="saveAccountInfo()">Save</button>
        <button onclick="resetUser(); location.reload()">Reset</button>
        <h3>History</h3><ul>${(user.history||[]).map(e=>`<li>${e.timestamp}: +£${e.amount.toFixed(2)}</li>`).join('')}</ul>
      ` : `
        <label>Username:<input id="usernameInput"></label>
        <label>Age:<input id="ageInput" type="number"></label>
        <button onclick="handleSignup()">Create Account</button>
      `;
      document.getElementById('authSection').innerHTML = authHTML;
    }

    function getSelectedPrefs() {
      return ['survey','quiz','image_tag','video','audio_ad']
        .filter(p => document.getElementById(`pref_${p}`).checked);
    }

    function handleSignup() {
      const u = document.getElementById('usernameInput').value;
      const age = parseInt(document.getElementById('ageInput').value);
      if (!u || isNaN(age)|| age<=0){return alert('Enter valid info');}
      const user = createUser(u, age);
      user.adPref = getSelectedPrefs();
      saveUser(user);
      populateFields();
    }

    function saveAccountInfo(){
      const user = loadUser();
      user.username = document.getElementById('usernameInput').value;
      user.age = +document.getElementById('ageInput').value;
      user.adPref = getSelectedPrefs();
      saveUser(user);
      populateFields();
    }

    function awardUser(payout) {
      const cut = 0.2;
      const earn = +(payout * (1 - cut)).toFixed(2);
      const u = loadUser();
      u.balance += earn;
      u.history = u.history||[];
      u.history.push({amount:earn, timestamp:new Date().toLocaleString()});
      saveUser(u);
      populateFields();
    }

    let app;

    function initializeApplixir() {
      const options = {
        zoneId:2050,
        devId:8943,
        adStatusCb: status => {
          console.log('Ad status=',status);
          if(status==='complete') awardUser(0.10);
        },
        verbosity:0
      };
      app = new Application(options);
      app.initialize();
    }

    function playAdIfAllowed() {
      const user = loadUser();
      if (!user || !user.adPref || user.adPref.includes('video')) {
        app.openPlayer();
      } else {
        setTimeout(playAdIfAllowed, 1000);
      }
    }

    window.onload = () => {
      initializeApplixir();
      populateFields();
      setTimeout(playAdIfAllowed, 1000);
    };
  </script>
</body>
</html>
